<%- include cumplimentar.ejs %>
<div>
<% if (locals.estado && locals.estado !== null) { %>
  <p><%=estado%></p>
<%}else{%>
        <form id="asignacionCumplimentarForm" autocomplete="off" action="<%= nuevopath %>" method="post" >
            <input type='hidden' name=pdID value='<%=pdID%>'>
            <% for (let i=0 ; i<asignacionsHorario.length; i++){%>
                <div>
                    <h2>Curso <%= asignacionsHorario[i].curso %></h2>
                    <% for (let j=0 ; j<asignacionsHorario[i].grupos.length; j++){%>
                        <h3><%= asignacionsHorario[i].grupos[j].grupoNombre %>
                        <button type="button" class="btn btn-default" onclick = "MostrarOcultar('table_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>')">
                        <span id ='button_table_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>'  class="glyphicon glyphicon-plus"></span> 
                        </button>
                        <button type="button" id='buttonSimplificar_table_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>' class="btn btn-default hidden" onclick = "simplificar('table_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>')">
                        Simplificar 
                        </button></h3>

                        <% let getAsignacions = function (hora,dia){
                                 let found = asignacionsHorario[i].grupos[j].asignaciones.filter(
                                     //me devuelve 8 y la bbdd de datos 08 por eso lo de 0+K
                                    asign => ((asign.horaInicio.split(':')[0] === ""+k || asign.horaInicio.split(':')[0] === "0"+k) && asign.dia === dia)
                                );
                                return found;
                        }%>
                        <table class="table hidden" id="table_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>">
                            <thead>
                                <tr>
                                <th scope="col">Hora</th>
                                <th scope="col">Lunes</th>
                                <th scope="col">Martes</th>
                                <th scope="col">Miércoles</th>
                                <th scope="col">Jueves</th>
                                <th scope="col">Viernes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <%  let k = 8;
                                    while (k <= 20){ %> 
                                <tr>
                                <td scope="col"><%= ""+k+"-"+(k+1) %></td>
                                <% let dias = ['L','M','X','J','V'];
                                    for(let d = 0; d<dias.length; d++){%>
                                        <td scope="col" id='horario_<%= asignacionsHorario[i].curso %>_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>_<%=dias[d]%>_<%=k%>' onclick="mostrar('horario_<%= asignacionsHorario[i].curso %>_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>_<%=dias[d]%>_<%=k%>')">
                                        <% let found = getAsignacions(k,dias[d])
                                            if (found.length === 0){%>
                                                <span>-</span>
                                            <%}
                                            for (let l=0; l< found.length; l++){
                                                if(l>0){%>
                                                    <span>/</span>
                                                <%}%>
                                                <span id='p_horario_<%= asignacionsHorario[i].curso %>_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>_<%=dias[d]%>_<%=k%>_<%l%>'> 
                                                <%if(found[l].asignaturaAcronimo !== null){ %>
                                                    <%=found[l].asignaturaAcronimo%>
                                                <%} else{%>
                                                    <%=found[l].asignaturaNombre%>
                                                <% } %>
                                                </span>
                                                <input type='hidden' name='momentaneo' id='horario_<%= asignacionsHorario[i].curso %>_<%=asignacionsHorario[i].grupos[j].grupoCodigo%>_<%=dias[d]%>_<%=k%>_<%=found[l].asignaturaIdentificador%>_<%=found[l].identificador%>' value='<%=found[l].identificador%>'>
                                            <% } %>
                                        </td>
                                <%}%>
                                </tr>
                                <% k++; }%>
                            </tbody>
                        </table>
                    <%}%>
                </div>

            <%}%>
            <input type='submit' value='Guardar'> 
        </form>
    <%}%>

</div>
<script>

//el multiselect del layout funciona con jquery
let estado = <%-JSON.stringify(estado)%>
let asignacionsHorario = <%-JSON.stringify(asignacionsHorario)%>;
function mostrar(id){
    let asignacions = [];
    let parent = document.getElementById(id);
    let children = document.getElementById(id).children;
    let childrenToBorrar = [];
    let habiaP = false;
    let momentaneo = [];
    for(let i =0; i<children.length; i++){
        if(children[i].tagName === 'SPAN'){
            habiaP = true;
            let text =children[i].innerHTML.trim()
            if (text && text !== '/' && text !==""){
                 asignacions.push(text)
            } 
            childrenToBorrar.push(children[i]);
        }
         if (children[i].tagName === 'INPUT' && children[i].getAttribute("name") !== 'momentaneo'){
            childrenToBorrar.push(children[i]);
        }
        if (children[i].tagName === 'INPUT' && children[i].getAttribute("name") === 'momentaneo'){
            let m = {};
            m.identificadorAsignatura = Number(children[i].getAttribute("id").split("_")[5]);
            m.identificadorAsignacion = Number(children[i].getAttribute("id").split("_")[6]);
            momentaneo.push(m);
        }
      
        
    }
    for ( let i=0; i<childrenToBorrar.length; i++){
        parent.removeChild(childrenToBorrar[i]);
    }
    if(habiaP){
        let curso = id.split("_")[1];
        let grupo = Number(id.split("_")[2]);
        let dia = id.split("_")[3];
        let horaInicio = id.split("_")[4];
        let cursoArray = asignacionsHorario.find(function (obj) { return obj.curso === curso});
        let grupoArray = cursoArray.grupos.find(function (obj) { return obj.grupoCodigo === grupo})
        let semestre = grupoArray.grupoNombre.split(".")[1];
        let asignaturas = grupoArray.asignaturas;
        //let asignacions = asignacionsHorario[curso][grupo].asignaciones;        
        let div = document.createElement('div');
        let options = '';
        for (let i = 0; i<asignaturas.length; i++){
            let s1 = semestre === '1' && (asignaturas[i].semestre === '1S' || asignaturas[i].semestre === '1S-2S' || asignaturas[i].semestre === 'A' || asignaturas[i].semestre === 'I')
            let s2 = semestre === '2' && (asignaturas[i].semestre === '2S' || asignaturas[i].semestre === '1S-2S' || asignaturas[i].semestre === 'A' || asignaturas[i].semestre === 'I')
            console.log(semestre)
            console.log(s1)
            if (s1 || s2){
            let n = "";
            asignaturas[i].acronimo !== null ? n=asignaturas[i].acronimo : n=asignaturas[i].nombre;
            options+='<option>'+n+'</option>'
            }

        }
        div.innerHTML = '<select id="select_'+id.replace(".","-")+'" class="selectpicker" multiple>'+options+'</select>'
        let nuevo = div.firstChild;
        parent.appendChild(nuevo);
        //hago el replace pq el pto lo detecta como clase y no lo encuentra
        $("#select_" + id.replace(".","-")).selectpicker('render');
        $("#select_" + id.replace(".","-")).selectpicker('val', asignacions);
        $("#select_" + id.replace(".","-")).selectpicker('toggle');

        //evento cuando se cierra
        $("#select_" + id.replace(".","-")).on('hidden.bs.select', function (sel) {
            let div2 = document.createElement('div');
            let selected = getSelectValues(nuevo); // devuelve un array cono los seleccionados
            if (selected.length === 0){
                div2.innerHTML ="<span>-</span>"
                parent.appendChild(div2.firstChild)
            }
            for (let l=0; l<selected.length; l++){
                if(l>0){

                    div2.innerHTML = "<span>/</span>"
                    parent.appendChild(div2.firstChild);
                }
                div2.innerHTML = "<span id='p_horario_"+curso+"_"+grupo+"_"+dia+"_"+horaInicio+"_"+l+"'>"+selected[l]+"</span>"
                parent.appendChild(div2.firstChild);
                let asign = asignaturas.find(function (obj) { return (obj.nombre === selected[l] || obj.acronimo === selected[l]) })

                let momentaneoAsign;
                if (asign){
                     momentaneoAsign = momentaneo.find(function(obj) {return obj.identificadorAsignatura === asign.identificador;});
                }
                //se añadirán las que no estaban en momentaneo, que eran las que tengo en la bbdd
                if (asign && !momentaneoAsign){
                    div2.innerHTML = "<input type='hidden' name='anadir' id='"+id+"_"+asign.identificador+"' value='"+id+"_"+asign.identificador+"'>"
                    parent.appendChild(div2.firstChild);
                }
            }
            //debo mandar a borrar en la bbdd las antiguas que he quitado
            for (let j=0; j<momentaneo.length; j++){
                let momentaneoAsign = asignaturas.find(function (obj) { return obj.identificador === momentaneo[j].identificadorAsignatura })
                let asign = ""
                if(momentaneoAsign){
                    asign =  selected.find(function (obj) { return (obj === momentaneoAsign.nombre || obj === momentaneoAsign.acronimo) })
                }
                if (!asign && momentaneoAsign){
                    div2.innerHTML = "<input type='hidden' name='eliminar' id='"+id+"_"+momentaneo[j].identificadorAsignacion+"' value='"+id+"_"+momentaneo[j].identificadorAsignacion+"'>"
                    parent.appendChild(div2.firstChild);   
                }
            }           
            
            parent.removeChild(nuevo.parentNode)//borro el select y el dropdown que lo capsula
        });

    }

}

function getSelectValues(select) {
  let result = [];
  let options = select && select.options;
  let opt;

  for (let i=0, iLen=options.length; i<iLen; i++) {
    opt = options[i];

    if (opt.selected) {
      result.push(opt.value || opt.text);
    }
  }
  return result;
}

function MostrarOcultar(id){
    let table = document.getElementById(id);
    let buttonSpan = document.getElementById('button_'+id)
    let buttonSimplificar = document.getElementById('buttonSimplificar_'+id)
    let clases = table.className.split(" ");
    let clases2 = buttonSimplificar.className.split(" ");
    let oculto = clases.find(function (obj) { return obj === 'hidden'});
    //si estaba oculto debo quitarlo
    if (oculto){
        table.className = "";
        buttonSimplificar.className = "";
        for (let i =0; i<clases.length; i++){
            if (clases[i] !== 'hidden'){
                table.className += " " +clases[i]
            }    
        }
        for (let i =0; i<clases2.length; i++){
            if (clases2[i] !== 'hidden'){
                buttonSimplificar.className += " " + clases2[i]
            }    
        }
        
        buttonSpan.className = "glyphicon glyphicon-minus"
    }
    //debo ocultarlo
    else{
        table.className += " hidden"
        buttonSimplificar.className += " hidden"
        buttonSpan.className = "glyphicon glyphicon-plus"

    }

}

function simplificar(id){
    let table = document.getElementById(id);
    let cellsOfRow="";
    let found=false;
    let buttonSimplificar = document.getElementById('buttonSimplificar_'+id)
    let text = buttonSimplificar.innerHTML.trim();
    if(text === 'Simplificar'){
        // Recorremos todas las filas con contenido de la tabla
        for (let i = 1; i < table.rows.length; i++){
            cellsOfRow = table.rows[i].getElementsByTagName('td');
            found = false;
            // Recorremos todas las celdas fe la fila que me interesan
            for (let j = 1; j < cellsOfRow.length && !found; j++){   
                if (!cellsOfRow[j].innerHTML.includes("<span>-</span>")){
                    found = true;
                }
            }
            if(!found){
                table.rows[i].className = 'hidden';
            } 
        }
        buttonSimplificar.innerHTML = 'Expandir'
    }else{
        // Recorremos todas las filas de la tabla y las hacemos visibles
        for (let i = 1; i < table.rows.length; i++){
            cellsOfRow = table.rows[i].getElementsByTagName('td');
            table.rows[i].className = '';  
        }
        buttonSimplificar.innerHTML = 'Simplificar'
    }
}

function Enviar(){
  return confirm("Una vez aprobada la asignación de profesores no podrá modificarla a menos que... ¿Seguro que quiere aprobarla?")
}

function Decidir(decision){
  let dec = document.getElementById('decision');
  dec.setAttribute('value', decision)
  if(confirm("Esta acción no se podrá deshacer. ¿Está seguro de que quiere continuar?")){
    document.getElementById("formDecision").submit();
  }
  
}
</script>